name: Auto Update Map

on:
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œç”¨
  schedule:
    - cron: "0 6 * * *"    # æ¯æœ6æ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼ˆæ—¥æœ¬æ™‚é–“15æ™‚ï¼‰

# 1ï¸âƒ£ GitHub Actionsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ (è¿½åŠ /ä¿®æ­£)
permissions:
  contents: write # ğŸ‘ˆ ã“ã‚Œã‚’è¿½åŠ ï¼

jobs:
  update-map:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2ï¸âƒ£ Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.11

    # 3ï¸âƒ£ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install earthengine-api folium geemap

    # 4ï¸âƒ£ Earth Engine èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    - name: Set up Earth Engine credentials
      run: |
        mkdir -p ~/.config/earthengine
        echo "$EE_CREDENTIALS" > ~/.config/earthengine/credentials
      env:
        EE_CREDENTIALS: ${{ secrets.EE_CREDENTIALS }}

    # 5ï¸âƒ£ ãƒãƒƒãƒ—ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
    - name: Run map generator
      run: |
        python map_generator.py

    # 6ï¸âƒ£ å¤‰æ›´ãŒã‚ã‚Œã°GitHubã¸Pushï¼ˆPATåˆ©ç”¨ï¼‰
    - name: Push changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/kitsukisaiseikyo-byte/shinjo-mugimap.git
        git add .
        git commit -m "auto update map $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push origin main

